<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊâãÊú∫Êñá‰ª∂‰∏ä‰º†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .title {
            text-align: center;
            letter-spacing: .5px;
            margin-bottom: 30px;
        }

        .panel {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .device-list {
            margin-top: 15px;
        }

        .device-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #fff;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .device-icon {
            margin-right: 10px;
            color: #4CAF50;
        }

        .upload-container {
            border: 2px dashed #ccc;
            padding: 25px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }

        #file-input {
            display: none;
        }

        #upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #upload-btn:hover {
            background-color: #45a049;
        }

        #selected-files {
            margin-top: 15px;
            color: #666;
        }

        #progress-container {
            margin-top: 20px;
            display: none;
        }

        #progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 6px;
            overflow: hidden;
        }

        #progress {
            height: 24px;
            background-color: #4CAF50;
            width: 0%;
            text-align: center;
            line-height: 24px;
            color: white;
            transition: width 0.3s;
        }

        #status {
            margin-top: 10px;
            margin-bottom: 5px;
            text-align: center;
            font-size: 14px;
        }

        .current-ip {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        /* ----- Êñá‰ª∂ËøõÂ∫¶Êù° ----- */
        .download-progress {
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: none;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .filename {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }

        .percentage {
            font-weight: 700;
            color: #2c7be5;
        }

        .progress-container {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #2c7be5, #00d97e);
            border-radius: 4px;
            transition: width 0.3s ease, background 0.3s;
        }

        .progress-indicator {
            position: absolute;
            right: 0;
            top: -4px;
            width: 16px;
            height: 16px;
            background: #fff;
            border: 2px solid #2c7be5;
            border-radius: 50%;
            transform: translateX(50%);
            z-index: 2;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6c757d;
        }

        .progress-details span {
            flex: 1;
        }

        .speed {
            text-align: center;
        }

        .remaining {
            text-align: right;
            padding-right: 10px;
        }

        .total {
            text-align: right;
            font-weight: 600;
        }

        /* Âä®ÁîªÊïàÊûú */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .active-transfer .progress-bar {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>

<body>
    <h1 class="title">ÊâãÊú∫Êñá‰ª∂‰∏ä‰º†</h1>

    <div class="upload-container">
        <input type="file" id="file-input" multiple>
        <button id="upload-btn" onclick="document.getElementById('file-input').click()">ÈÄâÊã©Êñá‰ª∂</button>
        <p id="selected-files"></p>
    </div>

    <div id="progress-container">
        <div id="progress-bar">
            <div id="progress">0%</div>
        </div>
        <div id="status"></div>
    </div>

    <!-- ÁîµËÑë‰º†ËæìÊñá‰ª∂ËøõÂ∫¶Êù° -->
    <div class="download-progress">
        <div class="progress-header">
            <span class="filename">Ê≠£Âú®‰∏ãËΩΩ: file.bin</span>
            <span class="percentage">0%</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar"></div>
            <div class="progress-indicator"></div>
        </div>
        <div class="progress-details">
            <span class="transferred">0 KB</span>
            <span class="speed">0 KB/s</span>
            <span class="remaining">Ââ©‰Ωô: --</span>
            <span class="total">0 KB</span>
        </div>
    </div>

    <div class="panel">
        <div class="panel-title">üì± ÂΩìÂâçËøûÊé•ËÆæÂ§áÔºà0Ôºâ</div>
        <div id="device-list" class="device-list">
            <div class="device-item">
                <span class="device-icon">üì±</span>
                <span>Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÂàóË°®...</span>
            </div>
        </div>
        <div id="current-ip" class="current-ip">
            ÊÇ®ÁöÑIP: <span id="your-ip">Ëé∑Âèñ‰∏≠...</span>
        </div>
    </div>

    <script>
        // ËøõÂ∫¶Êù°
        class DownloadProgress {
            constructor() {
                this.lastUpdate = 0;
                this.lastBytes = 0;
                this.speed = 0;
                this.totalSize = 0; // Á§∫‰æãÊÄªÂ§ßÂ∞è

                // Ëé∑ÂèñDOMÂÖÉÁ¥†
                this.elements = {
                    container: document.querySelector('.download-progress'),
                    filename: document.querySelector('.filename'),
                    percentage: document.querySelector('.percentage'),
                    progressBar: document.querySelector('.progress-bar'),
                    indicator: document.querySelector('.progress-indicator'),
                    transferred: document.querySelector('.transferred'),
                    speed: document.querySelector('.speed'),
                    remaining: document.querySelector('.remaining'),
                    total: document.querySelector('.total'),
                    filename: document.querySelector('.filename')
                };

                // ÂàùÂßãÂåñÊòæÁ§∫
                this.elements.total.textContent = this.formatSize(this.totalSize);
            }

            setDownloadTitle(title) {
                this.elements.container.style.display = 'block'
                this.elements.filename.textContent = `Ê≠£Âú®‰∏ãËΩΩ: ${title}`
            }

            update(currentBytes) {
                const now = Date.now();
                const elapsed = (now - this.lastUpdate) / 1000; // ËΩ¨Êç¢‰∏∫Áßí

                // ËÆ°ÁÆóÈÄüÂ∫¶ÔºàËá≥Â∞ë1ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
                if (elapsed >= 1) {
                    this.speed = (currentBytes - this.lastBytes) / elapsed;
                    this.lastUpdate = now;
                    this.lastBytes = currentBytes;
                }

                // ËÆ°ÁÆóËøõÂ∫¶ÂíåÂâ©‰ΩôÊó∂Èó¥
                const percent = Math.min(100, (currentBytes / this.totalSize) * 100);
                const remaining = this.speed > 0
                    ? this.formatTime((this.totalSize - currentBytes) / this.speed)
                    : '--';

                // Êõ¥Êñ∞UI
                this.elements.percentage.textContent = `${Math.floor(percent)}%`;
                this.elements.progressBar.style.width = `${percent}%`;
                this.elements.indicator.style.display = percent >= 100 ? 'none' : 'block';
                this.elements.transferred.textContent = this.formatSize(currentBytes);
                this.elements.speed.textContent = `${this.formatSize(this.speed)}/s`;
                this.elements.remaining.textContent = `Ââ©‰Ωô: ${remaining}`;

                // Ê∑ªÂä†ÊøÄÊ¥ªÁä∂ÊÄÅÁ±ª
                this.elements.container.classList.add('active-transfer');

                // ‰º†ËæìÂÆåÊàêÊó∂ÁßªÈô§Âä®Áîª
                if (percent >= 100) {
                    this.elements.container.classList.remove('active-transfer');
                    this.elements.progressBar.style.background = '#00d97e';
                    this.elements.container.style.display = 'none'
                }
            }

            formatSize(bytes) {
                if (bytes < 1024) return `${bytes} B`;
                if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
                return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            }

            formatTime(seconds) {
                if (seconds > 3600) return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
                if (seconds > 60) return `${Math.floor(seconds / 60)}m ${Math.floor(seconds % 60)}s`;
                return `${Math.floor(seconds)}s`;
            }
        }

        const progress = new DownloadProgress();

        class FileReceiver {
            constructor() {
                this.chunks = [];
                this.fileSize = 0;
                this.receivedSize = 0;
                this.fileName = '';
            }

            async startTransfer(metadata) {
                this.fileName = metadata.filename;
                this.fileSize = metadata.filesize;
                progress.totalSize = this.fileSize
                progress.setDownloadTitle(this.fileName)

                if (this.canUseFileSystemAPI()) {
                    try {
                        this.fileHandle = await window.showSaveFilePicker({
                            suggestedName: this.fileName
                        });
                        this.writer = await this.fileHandle.createWritable();
                        return true;
                    } catch (err) {
                        console.warn("Êó†Ê≥ï‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüAPI:", err);
                        return this.useFallback();
                    }
                } else {
                    return this.useFallback();
                }
            }

            canUseFileSystemAPI() {
                return 'showSaveFilePicker' in window && window.isSecureContext;
            }

            useFallback() {
                this.chunks = [];
                this.receivedSize = 0;
                return true;
            }

            async receiveChunk(chunk) {
                if (this.writer) {
                    await this.writer.write(chunk);
                } else {
                    this.chunks.push(chunk);
                }
                this.receivedSize += chunk.byteLength;

                progress.update(Math.min(this.receivedSize, progress.totalSize));
            }

            async completeTransfer() {
                if (this.writer) {
                    await this.writer.close();
                } else {
                    // ‰º†Áªü‰∏ãËΩΩÊñπÂºè
                    const blob = new Blob(this.chunks);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            }
        }

        const panelTitleEle = document.querySelector('.panel-title')

        fetch('/record_ip')

        // =============================== websocket ===============================

        let fileWriter = null
        let receivedFile = null
        let filenames = null
        const socket = new WebSocket(`ws://${window.location.host}/ws/connect`)
        const fileReceiver = new FileReceiver()
        socket.onmessage = async (event) => {
            if (event.data.startsWith !== undefined && event.data.startsWith("file_request:")) {
                const [_, filename, sender] = event.data.split(":")
                filenames = filename
                showFileRequestDialog(filename, sender)
            } else if (typeof event.data === "string") {
                const data = JSON.parse(event.data)
                if (data.type === "file_metadata") {
                    await fileReceiver.startTransfer(data)
                } else if (data.type === "transfer_complete") {
                    await fileReceiver.completeTransfer()
                }
            } else {
                await fileReceiver.receiveChunk(await event.data.arrayBuffer())
            }
        }

        function showFileRequestDialog(filename, sender) {
            if (confirm(`ÊòØÂê¶Êé•Êî∂Êù•Ëá™ ${sender} ÁöÑÊñá‰ª∂ ${filename}Ôºü`)) {
                socket.send(`file_response:${sender}:accept`)
            } else {
                socket.send(`file_response:${sender}:reject`)
            }
        }

        // =============================== websocket ===============================

        async function getAndReportIP() {
            // Ëé∑ÂèñÂπ∂‰∏äÊä•ÂΩìÂâçËÆæÂ§áIP
            try {
                // Â∞ùËØïÈÄöËøáWebRTCËé∑ÂèñÂÜÖÁΩëIP
                const localIP = await new Promise((resolve) => {
                    const pc = new RTCPeerConnection({ iceServers: [] });
                    pc.createDataChannel("");
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));

                    pc.onicecandidate = ice => {
                        if (ice.candidate) {
                            const match = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(ice.candidate.candidate);
                            if (match) resolve(match[1]);
                        }
                    };

                    setTimeout(() => resolve(null), 2000);
                });

                // Ëé∑ÂèñÂêéÁ´ØÊ£ÄÊµãÂà∞ÁöÑIP
                const res = await fetch('/detect_ip');
                const { ip: serverDetectedIP } = await res.json();

                // ‰ºòÂÖà‰ΩøÁî®WebRTCËé∑ÂèñÁöÑIPÔºåÂ§±Ë¥•Âàô‰ΩøÁî®ÂêéÁ´ØÊ£ÄÊµãÁöÑIP
                const finalIP = localIP || serverDetectedIP;
                document.getElementById('your-ip').textContent = finalIP || 'Êú™Áü•';

                // ‰∏äÊä•IPÂà∞ÊúçÂä°Âô®
                if (finalIP) {
                    await fetch(`/record_ip?ip=${encodeURIComponent(finalIP)}`);
                }
            } catch (e) {
                console.warn("IPËé∑ÂèñÂ§±Ë¥•:", e);
            }
        }

        async function updateDeviceList() {
            // Ëé∑ÂèñÂπ∂ÊòæÁ§∫ËÆæÂ§áÂàóË°®
            try {
                const res = await fetch('/get_ips');
                const { devices } = await res.json();
                panelTitleEle.innerText = `üì± ÂΩìÂâçËøûÊé•ËÆæÂ§áÔºà${devices.length}Ôºâ`

                const deviceList = document.getElementById('device-list');
                if (devices && devices.length > 0) {
                    deviceList.innerHTML = devices.map(ip => `
                        <div class="device-item">
                            <span class="device-icon">üì±</span>
                            <span>${ip}</span>
                        </div>
                    `).join('');
                } else {
                    deviceList.innerHTML = '<div class="device-item">ÊöÇÊó†ÂÖ∂‰ªñËÆæÂ§áËøûÊé•</div>';
                }
            } catch (e) {
                console.error("Ëé∑ÂèñËÆæÂ§áÂàóË°®Â§±Ë¥•:", e);
            }
        }

        // 3. ÂàùÂßãÂåñËÆæÂ§áÂàóË°®ÂíåIPÊòæÁ§∫
        getAndReportIP();
        updateDeviceList();

        // ÊØè5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°ËÆæÂ§áÂàóË°®
        setInterval(updateDeviceList, 5000);

        // 4. Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩÔºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
        const fileInput = document.getElementById('file-input');
        const selectedFiles = document.getElementById('selected-files');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress');
        const status = document.getElementById('status');

        fileInput.addEventListener('change', function (e) {
            if (this.files.length > 0) {
                let fileNames = [];
                for (let i = 0; i < this.files.length; i++) {
                    fileNames.push(this.files[i].name);
                }
                selectedFiles.textContent = "Â∑≤ÈÄâÊã©: " + fileNames.join(", ");
                uploadFiles(this.files);
            }
        });

        async function uploadFiles(files) {
            progressContainer.style.display = "block";
            status.textContent = "ÂáÜÂ§á‰∏ä‰º†...";

            const formData = new FormData();
            formData.append('file', files[0]);

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '%';
                    }
                });

                xhr.addEventListener('load', function () {
                    if (xhr.status === 200) {
                        status.textContent = "‰∏ä‰º†ÊàêÂäü!";
                        setTimeout(() => {
                            progressContainer.style.display = "none";
                            selectedFiles.textContent = "";
                            fileInput.value = "";
                        }, 2000);
                    } else {
                        status.textContent = "‰∏ä‰º†Â§±Ë¥•: " + xhr.responseText;
                    }
                });

                xhr.open('POST', '/upload', true);
                xhr.send(formData);

                status.textContent = "‰∏ä‰º†‰∏≠...";
            } catch (error) {
                status.textContent = "‰∏ä‰º†Âá∫Èîô: " + error.message;
            }
        }

        function handlePageUnload() {
            // Á¶ªÂºÄÈ°µÈù¢Êó∂ÁßªÈô§IP
            fetch('/remove_ip', {
                method: 'GET',
                keepalive: true
            }).catch((e) => { console.log(e) })
        }

        window.addEventListener('beforeunload', handlePageUnload)
        window.addEventListener('pagehide', handlePageUnload)
        window.addEventListener('unload', handlePageUnload)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                handlePageUnload()
            }
        })
    </script>
</body>

</html>